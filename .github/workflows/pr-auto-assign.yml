name: ğŸ‘¥ PR ìë™ í• ë‹¹

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
      id: file-analysis
      run: |
        # ë³€ê²½ëœ íŒŒì¼ë“¤ ë¶„ì„
        BACKEND_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "^backend/" | wc -l)
        FRONTEND_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "^frontend/" | wc -l)
        DOCS_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "^docs/|\.md$" | wc -l)
        TEST_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "test_|_test\.py$" | wc -l)
        CONFIG_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "\.yml$|\.yaml$|\.json$|requirements\.txt$|Dockerfile" | wc -l)
        
        echo "backend_changed=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
        echo "frontend_changed=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
        echo "docs_changed=$DOCS_CHANGED" >> $GITHUB_OUTPUT
        echo "test_changed=$TEST_CHANGED" >> $GITHUB_OUTPUT
        echo "config_changed=$CONFIG_CHANGED" >> $GITHUB_OUTPUT

    - name: ğŸ‘¤ ë‹´ë‹¹ì ìë™ í• ë‹¹
      uses: actions/github-script@v6
      with:
        script: |
          const backendChanged = ${{ steps.file-analysis.outputs.backend_changed }};
          const frontendChanged = ${{ steps.file-analysis.outputs.frontend_changed }};
          const docsChanged = ${{ steps.file-analysis.outputs.docs_changed }};
          const testChanged = ${{ steps.file-analysis.outputs.test_changed }};
          const configChanged = ${{ steps.file-analysis.outputs.config_changed }};
          
          // íŒ€ ë©¤ë²„ ì •ì˜ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const teamMembers = {
            backend: ['backend-dev1', 'backend-dev2'], // ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
            frontend: ['frontend-dev1', 'frontend-dev2'], // ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
            devops: ['devops-dev1'], // ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
            docs: ['tech-writer1'], // ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
            all: ['team-lead1', 'senior-dev1'] // ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
          };
          
          let assignees = [];
          let reviewers = [];
          
          // ë³€ê²½ ì˜ì—­ì— ë”°ë¥¸ í• ë‹¹ ë¡œì§
          if (backendChanged > 0) {
            const backendReviewer = teamMembers.backend[Math.floor(Math.random() * teamMembers.backend.length)];
            reviewers.push(backendReviewer);
          }
          
          if (frontendChanged > 0) {
            const frontendReviewer = teamMembers.frontend[Math.floor(Math.random() * teamMembers.frontend.length)];
            reviewers.push(frontendReviewer);
          }
          
          if (configChanged > 0) {
            const devopsReviewer = teamMembers.devops[Math.floor(Math.random() * teamMembers.devops.length)];
            reviewers.push(devopsReviewer);
          }
          
          if (docsChanged > 0) {
            const docsReviewer = teamMembers.docs[Math.floor(Math.random() * teamMembers.docs.length)];
            reviewers.push(docsReviewer);
          }
          
          // ëŒ€í˜• PRì´ê±°ë‚˜ ì—¬ëŸ¬ ì˜ì—­ ë³€ê²½ ì‹œ ì‹œë‹ˆì–´ ê°œë°œì ì¶”ê°€
          const totalFiles = backendChanged + frontendChanged + docsChanged + configChanged;
          if (totalFiles > 10 || (backendChanged > 0 && frontendChanged > 0)) {
            const seniorReviewer = teamMembers.all[Math.floor(Math.random() * teamMembers.all.length)];
            reviewers.push(seniorReviewer);
          }
          
          // ì¤‘ë³µ ì œê±°
          reviewers = [...new Set(reviewers)];
          
          // PR ì‘ì„±ìëŠ” ë¦¬ë·°ì–´ì—ì„œ ì œì™¸
          reviewers = reviewers.filter(reviewer => reviewer !== context.payload.pull_request.user.login);
          
          // ë¦¬ë·°ì–´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¦¬ë·°ì–´ í• ë‹¹
          if (reviewers.length === 0) {
            reviewers = [teamMembers.all[0]];
          }
          
          try {
            // ë¦¬ë·°ì–´ ìš”ì²­
            if (reviewers.length > 0) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: reviewers
              });
              
              // í• ë‹¹ ê²°ê³¼ ëŒ“ê¸€
              const comment = `
              ## ğŸ‘¥ ë¦¬ë·°ì–´ ìë™ í• ë‹¹ ì™„ë£Œ
              
              ë‹¤ìŒ ë¶„ë“¤ì´ ë¦¬ë·°ì–´ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤:
              ${reviewers.map(reviewer => `- @${reviewer}`).join('\n')}
              
              ### ğŸ“‹ í• ë‹¹ ê¸°ì¤€
              - ë°±ì—”ë“œ ë³€ê²½: ${backendChanged > 0 ? 'âœ…' : 'âŒ'}
              - í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½: ${frontendChanged > 0 ? 'âœ…' : 'âŒ'}
              - ë¬¸ì„œ ë³€ê²½: ${docsChanged > 0 ? 'âœ…' : 'âŒ'}
              - ì„¤ì • ë³€ê²½: ${configChanged > 0 ? 'âœ…' : 'âŒ'}
              - í…ŒìŠ¤íŠ¸ ë³€ê²½: ${testChanged > 0 ? 'âœ…' : 'âŒ'}
              
              ë¦¬ë·°ì–´ ë¶„ë“¤ê»˜ì„œëŠ” 24ì‹œê°„ ë‚´ ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ™
              `;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('ë¦¬ë·°ì–´ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error.message);
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•Œë¦¼ ëŒ“ê¸€
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ## âš ï¸ ìë™ í• ë‹¹ ì‹¤íŒ¨
              
              ë¦¬ë·°ì–´ ìë™ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
              ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë¦¬ë·°ì–´ë¥¼ ì§€ì •í•´ ì£¼ì„¸ìš”.
              
              ì˜¤ë¥˜ ë‚´ìš©: ${error.message}
              `
            });
          } 