name: ğŸ’¬ PR ìë™ ëŒ“ê¸€

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-comment:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“Š ë³€ê²½ ì‚¬í•­ ë¶„ì„
      id: changes
      run: |
        # ë³€ê²½ëœ íŒŒì¼ ìˆ˜ ê³„ì‚°
        FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)
        
        # ì¶”ê°€/ì‚­ì œëœ ë¼ì¸ ìˆ˜ ê³„ì‚°
        LINES_ADDED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$1} END {print sum}')
        LINES_DELETED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$2} END {print sum}')
        
        # ë³€ê²½ëœ íŒŒì¼ íƒ€ì… ë¶„ì„
        BACKEND_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "^backend/" | wc -l)
        FRONTEND_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "^frontend/" | wc -l)
        TEST_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "test_|_test\.py$" | wc -l)
        
        echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
        echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
        echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
        echo "backend_files=$BACKEND_FILES" >> $GITHUB_OUTPUT
        echo "frontend_files=$FRONTEND_FILES" >> $GITHUB_OUTPUT
        echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT

    - name: ğŸ’¬ PR í™˜ì˜ ëŒ“ê¸€ ì‘ì„±
      uses: actions/github-script@v6
      with:
        script: |
          const filesChanged = ${{ steps.changes.outputs.files_changed }};
          const linesAdded = ${{ steps.changes.outputs.lines_added }};
          const linesDeleted = ${{ steps.changes.outputs.lines_deleted }};
          const backendFiles = ${{ steps.changes.outputs.backend_files }};
          const frontendFiles = ${{ steps.changes.outputs.frontend_files }};
          const testFiles = ${{ steps.changes.outputs.test_files }};
          
          let emoji = "ğŸš€";
          let sizeLabel = "ì‘ì€";
          
          if (filesChanged > 20) {
            emoji = "ğŸ”¥";
            sizeLabel = "ëŒ€í˜•";
          } else if (filesChanged > 10) {
            emoji = "âš¡";
            sizeLabel = "ì¤‘ê°„";
          }
          
          let areas = [];
          if (backendFiles > 0) areas.push(`ë°±ì—”ë“œ (${backendFiles}ê°œ)`);
          if (frontendFiles > 0) areas.push(`í”„ë¡ íŠ¸ì—”ë“œ (${frontendFiles}ê°œ)`);
          if (testFiles > 0) areas.push(`í…ŒìŠ¤íŠ¸ (${testFiles}ê°œ)`);
          
          const comment = `
          ## ${emoji} PR ë¶„ì„ ë¦¬í¬íŠ¸
          
          ì•ˆë…•í•˜ì„¸ìš” @${{ github.event.pull_request.user.login }}ë‹˜! PRì„ ìƒì„±í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.
          
          ### ğŸ“Š ë³€ê²½ ì‚¬í•­ ìš”ì•½
          - **í¬ê¸°**: ${sizeLabel} PR (${filesChanged}ê°œ íŒŒì¼)
          - **ë¼ì¸ ë³€ê²½**: +${linesAdded} / -${linesDeleted}
          - **ì˜í–¥ ì˜ì—­**: ${areas.join(', ') || 'ê¸°íƒ€'}
          
          ### âœ… ìë™ ì²´í¬ë¦¬ìŠ¤íŠ¸
          - [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì¶”ê°€/ìˆ˜ì •ë˜ì—ˆë‚˜ìš”? ${testFiles > 0 ? 'âœ…' : 'âŒ'}
          - [ ] ë°±ì—”ë“œ ë³€ê²½ì‚¬í•­ì´ ìˆë‚˜ìš”? ${backendFiles > 0 ? 'âœ…' : 'âŒ'}
          - [ ] í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ì‚¬í•­ì´ ìˆë‚˜ìš”? ${frontendFiles > 0 ? 'âœ…' : 'âŒ'}
          
          ### ğŸ”„ ë‹¤ìŒ ë‹¨ê³„
          1. ğŸ§ª ìë™ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤
          2. ğŸ‘¥ ë¦¬ë·°ì–´ê°€ ìë™ í• ë‹¹ë©ë‹ˆë‹¤
          3. ğŸ·ï¸ ê´€ë ¨ ë¼ë²¨ì´ ìë™ ì¶”ê°€ë©ë‹ˆë‹¤
          
          ë¦¬ë·° ê³¼ì •ì—ì„œ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ëŒ“ê¸€ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”! ğŸ™‹â€â™‚ï¸
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: ğŸ¯ PR í¬ê¸°ë³„ ì¶”ê°€ ì•ˆë‚´
      if: steps.changes.outputs.files_changed > 20
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `
            ## âš ï¸ ëŒ€í˜• PR ì•ˆë‚´
            
            ì´ PRì€ 20ê°œ ì´ìƒì˜ íŒŒì¼ì„ ë³€ê²½í•˜ëŠ” ëŒ€í˜• PRì…ë‹ˆë‹¤.
            
            ### ğŸ“‹ ê¶Œì¥ ì‚¬í•­
            - ê°€ëŠ¥í•˜ë©´ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• ì„ ê³ ë ¤í•´ ì£¼ì„¸ìš”
            - ë¦¬ë·° ì‹œê°„ì´ í‰ì†Œë³´ë‹¤ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤
            - ë³€ê²½ ì‚¬í•­ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”
            
            ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ™
            `
          }); 