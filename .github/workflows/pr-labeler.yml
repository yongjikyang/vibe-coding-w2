name: ğŸ·ï¸ PR ìë™ ë¼ë²¨ë§

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  labeler:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” ë³€ê²½ ì‚¬í•­ ë¶„ì„
      id: analyze
      run: |
        # ë³€ê²½ëœ íŒŒì¼ë“¤ ë¶„ì„
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        
        # ì˜ì—­ë³„ íŒŒì¼ ìˆ˜ ê³„ì‚°
        BACKEND_FILES=$(echo "$CHANGED_FILES" | grep -E "^backend/" | wc -l)
        FRONTEND_FILES=$(echo "$CHANGED_FILES" | grep -E "^frontend/" | wc -l)
        DOCS_FILES=$(echo "$CHANGED_FILES" | grep -E "^docs/|\.md$" | wc -l)
        TEST_FILES=$(echo "$CHANGED_FILES" | grep -E "test_|_test\.py$|^tests/" | wc -l)
        CONFIG_FILES=$(echo "$CHANGED_FILES" | grep -E "\.yml$|\.yaml$|\.json$|requirements\.txt$|Dockerfile|\.env" | wc -l)
        GITHUB_FILES=$(echo "$CHANGED_FILES" | grep -E "^\.github/" | wc -l)
        
        # ì´ ë³€ê²½ íŒŒì¼ ìˆ˜
        TOTAL_FILES=$(echo "$CHANGED_FILES" | wc -l)
        
        # ë³€ê²½ëœ ë¼ì¸ ìˆ˜ ê³„ì‚°
        LINES_ADDED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$1} END {print sum}')
        LINES_DELETED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$2} END {print sum}')
        
        echo "backend_files=$BACKEND_FILES" >> $GITHUB_OUTPUT
        echo "frontend_files=$FRONTEND_FILES" >> $GITHUB_OUTPUT
        echo "docs_files=$DOCS_FILES" >> $GITHUB_OUTPUT
        echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
        echo "config_files=$CONFIG_FILES" >> $GITHUB_OUTPUT
        echo "github_files=$GITHUB_FILES" >> $GITHUB_OUTPUT
        echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
        echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
        echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT

    - name: ğŸ·ï¸ ë¼ë²¨ ìë™ ì¶”ê°€
      uses: actions/github-script@v6
      with:
        script: |
          const backendFiles = parseInt('${{ steps.analyze.outputs.backend_files }}');
          const frontendFiles = parseInt('${{ steps.analyze.outputs.frontend_files }}');
          const docsFiles = parseInt('${{ steps.analyze.outputs.docs_files }}');
          const testFiles = parseInt('${{ steps.analyze.outputs.test_files }}');
          const configFiles = parseInt('${{ steps.analyze.outputs.config_files }}');
          const githubFiles = parseInt('${{ steps.analyze.outputs.github_files }}');
          const totalFiles = parseInt('${{ steps.analyze.outputs.total_files }}');
          const linesAdded = parseInt('${{ steps.analyze.outputs.lines_added }}');
          const linesDeleted = parseInt('${{ steps.analyze.outputs.lines_deleted }}');
          
          let labels = [];
          
          // ì˜ì—­ë³„ ë¼ë²¨
          if (backendFiles > 0) labels.push('area:backend');
          if (frontendFiles > 0) labels.push('area:frontend');
          if (docsFiles > 0) labels.push('area:docs');
          if (testFiles > 0) labels.push('area:test');
          if (configFiles > 0) labels.push('area:config');
          if (githubFiles > 0) labels.push('area:ci');
          
          // í¬ê¸°ë³„ ë¼ë²¨
          if (totalFiles <= 3 && (linesAdded + linesDeleted) <= 50) {
            labels.push('size:XS');
          } else if (totalFiles <= 8 && (linesAdded + linesDeleted) <= 200) {
            labels.push('size:S');
          } else if (totalFiles <= 15 && (linesAdded + linesDeleted) <= 500) {
            labels.push('size:M');
          } else if (totalFiles <= 30 && (linesAdded + linesDeleted) <= 1000) {
            labels.push('size:L');
          } else {
            labels.push('size:XL');
          }
          
          // PR ì œëª© ê¸°ë°˜ íƒ€ì… ë¼ë²¨
          const title = context.payload.pull_request.title.toLowerCase();
          const body = context.payload.pull_request.body || '';
          
          if (title.includes('[feat]') || title.includes('feature') || title.includes('add')) {
            labels.push('type:feature');
          } else if (title.includes('[fix]') || title.includes('bug') || title.includes('fix')) {
            labels.push('type:bug');
          } else if (title.includes('[refactor]') || title.includes('refactor')) {
            labels.push('type:refactor');
          } else if (title.includes('[docs]') || title.includes('documentation')) {
            labels.push('type:docs');
          } else if (title.includes('[test]') || title.includes('test')) {
            labels.push('type:test');
          } else if (title.includes('[chore]') || title.includes('chore')) {
            labels.push('type:chore');
          } else if (title.includes('[style]') || title.includes('style')) {
            labels.push('type:style');
          }
          
          // ìš°ì„ ìˆœìœ„ ë¼ë²¨ (í‚¤ì›Œë“œ ê¸°ë°˜)
          if (title.includes('urgent') || title.includes('critical') || title.includes('hotfix')) {
            labels.push('priority:high');
          } else if (title.includes('minor') || title.includes('small')) {
            labels.push('priority:low');
          } else {
            labels.push('priority:medium');
          }
          
          // íŠ¹ìˆ˜ ìƒí™© ë¼ë²¨
          if (testFiles === 0 && (backendFiles > 0 || frontendFiles > 0)) {
            labels.push('needs-tests');
          }
          
          if (docsFiles === 0 && (backendFiles > 0 || frontendFiles > 0)) {
            labels.push('needs-docs');
          }
          
          if (context.payload.pull_request.draft) {
            labels.push('status:draft');
          } else {
            labels.push('status:ready');
          }
          
          // ë¼ë²¨ ì¤‘ë³µ ì œê±°
          labels = [...new Set(labels)];
          
          try {
            // ê¸°ì¡´ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const currentLabelNames = currentLabels.map(label => label.name);
            const newLabels = labels.filter(label => !currentLabelNames.includes(label));
            
            if (newLabels.length > 0) {
              // ìƒˆ ë¼ë²¨ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: newLabels
              });
              
              // ë¼ë²¨ë§ ê²°ê³¼ ëŒ“ê¸€
              const comment = `
              ## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ
              
              ë‹¤ìŒ ë¼ë²¨ë“¤ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:
              ${newLabels.map(label => `\`${label}\``).join(', ')}
              
              ### ğŸ“Š ë¶„ì„ ê²°ê³¼
              - **ì´ ë³€ê²½ íŒŒì¼**: ${totalFiles}ê°œ
              - **ë¼ì¸ ë³€ê²½**: +${linesAdded} / -${linesDeleted}
              - **ì˜í–¥ ì˜ì—­**: ${[
                backendFiles > 0 ? `ë°±ì—”ë“œ(${backendFiles})` : null,
                frontendFiles > 0 ? `í”„ë¡ íŠ¸ì—”ë“œ(${frontendFiles})` : null,
                docsFiles > 0 ? `ë¬¸ì„œ(${docsFiles})` : null,
                testFiles > 0 ? `í…ŒìŠ¤íŠ¸(${testFiles})` : null,
                configFiles > 0 ? `ì„¤ì •(${configFiles})` : null,
                githubFiles > 0 ? `CI/CD(${githubFiles})` : null
              ].filter(Boolean).join(', ') || 'ê¸°íƒ€'}
              
              ë¼ë²¨ì´ ì˜ëª» ì„¤ì •ëœ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”! ğŸ™
              `;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('ë¼ë²¨ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error.message);
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ## âš ï¸ ìë™ ë¼ë²¨ë§ ì‹¤íŒ¨
              
              ë¼ë²¨ ìë™ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
              ìˆ˜ë™ìœ¼ë¡œ ë¼ë²¨ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.
              
              ì˜¤ë¥˜ ë‚´ìš©: ${error.message}
              `
            });
          } 